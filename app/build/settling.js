var path=window.path||null,rectDim=10,divider=5e4,padding=4,countries=["Turkey","Iraq","Lebanon","Egypt","Jordan"],dataProp="Refugees_2014",rectsPerSide=0,makeWaffle=function(a,b,c){for(var d,e=0,f=0,g=0;b>=g;g++)d=b>g?a.append("rect").attr({x:e*rectDim+e*padding,y:f*rectDim+f*padding,width:rectDim,height:rectDim}):a.append("rect").attr({x:e*rectDim+e*padding,y:f*rectDim+f*padding,width:rectDim,height:rectDim*c}),++e>rectsPerSide&&(e=0,f++);a.selectAll("rect").style("opacity",0),Util.addOnInViewCallback(function(){a.selectAll("rect").transition().duration(100).delay(function(a,b){return 100*b}).style("opacity",1)},this)},makeWaffles=Promise.method(function(a){var b=a[0],c=a[1],d=a[2];return Promise.join(Data.getCountryStats(),Data[d]()).then(function(){var d=arguments[0][0].data,e=arguments[0][1];e=topojson.feature(e,e.objects[c]).features,countries.forEach(function(a){rectsPerSide=Math.max(d[a][dataProp]/divider,rectsPerSide)}),rectsPerSide=Math.ceil(Math.sqrt(rectsPerSide));var f=b.append("g").classed("waffles",!0),g=f.selectAll("g.waffle").data(e);g.enter().append("g").classed("waffle",!0).each(function(a){var b=path.centroid(a),c=a.properties.NAME;if(countries.indexOf(c)>-1){var e=Math.floor(d[c][dataProp]/divider),f=d[c][dataProp]%divider/divider,g=d3.select(this).attr({num:d[c][dataProp],transform:"translate("+(b[0]-Math.min(rectsPerSide,e)*(rectDim+padding)/2-padding)+","+(b[1]+("Jordan"===c?30:10))+")"});makeWaffle(g,e,f)}});return Util.addOnInViewCallback(function(){f.selectAll("rect").each(Util.tipsyIt(function(a){return"<span class='val'>"+d3.format("0,")(d[a.properties.NAME][dataProp])+"</span> refugees"}))},this),Promise.resolve(a)})}),makeRestOfWorld=Promise.method(function(a){a[0];return Data.getCountryStats().then(function(a){var b=a.data,c=d3.keys(b),d=0,e=0;c.forEach(function(a){d+=b[a][dataProp],-1===countries.indexOf(a)&&(e+=b[a][dataProp])}),d3.select(".other text").text("Rest of the World ("+d3.format("0%")(e/d)+")");var f=Math.floor(e/divider),g=e%divider/divider,h=d3.select(".other g");makeWaffle(h,f,g),h.selectAll("rect").each(Util.tipsyIt(function(a){return"<span class='val'>"+d3.format("0,")(e)+"</span> refugees"}))})}),makeLegend=Promise.method(function(a){var b=d3.select(".legend").append("g").attr("transform","translate(20, 20)");return b.append("rect").attr({x:0,y:0,width:rectDim,height:rectDim}),b.append("text").attr({x:rectDim+2*padding,y:10}).text(d3.format("0,")(divider)+" refugees"),Promise.resolve(a)});Map.makeRaster("#map",imageRegionPairs.region.image,imageRegionPairs.region.geoProp,imageRegionPairs.region.geoGet).then(Map.makeToggle).then(Map.makeRegions).then(Map.makeLabels).then(makeWaffles).then(makeRestOfWorld).then(makeLegend).then(Util.postReady);